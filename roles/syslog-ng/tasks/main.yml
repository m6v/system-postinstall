---
- name: Установка зависимостей для отправки и отображения сообщений
  apt:
    name: "{{ item }}"
    state: present
  loop:
    - python-dbus
    - fly-notifications

- name: Копирование файлов конфигурации syslog-ng
  copy:
    src: "{{ item }}"
    dest: /etc/syslog-ng/conf.d
    owner: root
    group: root
  loop:
    - afick-events.conf
    - astra-events.conf
    - audit-events.conf
    - rebus-events.conf
    - astra-custom.conf

- name: Настройка и копирование файла с источниками и точками назначения
  # TODO Разобраться почему "{{ hostvars[ 'arm-abi' ].ansible_default_ipv4.address }}" присваивается второй ip-адрес АРМ-АБИ, а не тот, что указан в инвентори
  # Если отключить второй интерфейс, то получаем ошибку. Пока копируем файл во временный каталог
  template:
    src: astra-custom.j2
    dest: /tmp/astra-custom.conf

- name: Изменение настроек auditd
  # Удалить (переименовать) файл 10-parsec.rules, задающий для всех событий auditd
  # ключ parsec-p, после чего их невозможно фильтровать по собственным ключам
  shell: |
    if [ -f /etc/audit/rules.d/10-parsec.rules ]; then
      mv /etc/audit/rules.d/10-parsec.rules /etc/audit/rules.d/10-parsec.rules.bak;
    fi

- name: Копирование конфигурационного файла auditd
  copy:
    src: astra-custom.rules
    dest: /etc/audit/rules.d/

- name: Копирование файла с классами обработчиков событий и файла с классом отправки сообщений в dbus
  copy:
    src: "{{ item }}"
    dest: /usr/local/lib/python2.7/dist-packages
  loop:
    - events_parsers.py
    - dbus_sender.py

- name: Настройка пути к классам обработчиков событий syslog-ng
  lineinfile:
    path: /etc/default/syslog-ng
    line: PYTHONPATH="/usr/local/lib/python2.7/dist-packages"
    insertafter: EOF

- name: Настройка формата представления даты и времени в логах syslog-ng
  # Добавить в группу параметров options параметр ts-format(iso);
  replace:
    path: /etc/syslog-ng/syslog-ng.conf
    # Вставить после первой группы параметр ts-format(iso)
    regexp: '(^options[\s\S]*?)( ts-format\(iso\);\n};|\n};)'
    replace: '\1 ts-format(iso);\n};'

- name: Копирование конфигурационного файла с разрешением приема широковещательных сообщений по dbus
  copy:
    src: fly-notificationsrc
    dest: /home/{{ admin_name.stdout }}/.config

# В Астре 1.8 возможно следует (нужно проверять) включить дополнительные правили аудита
# - name: Включить правила PARSEC-аудита процессов и файлов и правила сетевого PARSEC-аудита
#   shell:
#     astra-audit-control enable; astra-audit-network-control enable

